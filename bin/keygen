#!/bin/sh

# TODO
# * Add default file
# * Add usage

FILE=''

query=''
search=''
file=''

exit_usage() {
  echo 'insert usage'
}

exit_error() {
  printf 'keygen: '
  case "$1" in
    1) printf 'query and search are incompatible operations' ;;
    2) printf "missing argument to $2" ;;
    3) printf "$2: no such file" ;;
    4) printf "invalid argument: $2" ;;
    *)
      printf 'there has been a terrible blunder, abandon all hope!\n'
      exit 255
      ;;
  esac
  printf '\nTry "keygen --help" for more information.\n'
  exit "$1"
}

while [ "$#" -gt 0 ]; do
  case "$1" in
    -h | --help)
      exit_usage
      ;;

    -q)
      [ -n "${search}" ] && exit_error 1
      if [ -n "$2" ]; then
        query="$2"
        shift 2
      else
        exit_error 2 "$1"
      fi
      ;;

    -s)
      [ -n "${query}" ] && exit_error 1
      if [ -n "$2" ]; then
        search="$2"
        shift 2
      else
        exit_error 2 "$1"
      fi
      ;;

    -f)
      if [ -f "$2" ]; then
        file="$2"
        shift 2
      else
        exit_error 3 "$2"
      fi
      ;;

    *)
      exit_error 4 "$1"
      ;;
  esac
done

[ -z "${file}" ] && file="${FILE}"

if [ -n "${query}" ]; then
  gpg -d "${file}" | jq '.["'"${query}"'"]'
elif [ -n "${search}" ]; then
  gpg -d "${file}" | jq '.' | grep --color=auto -i "${search}"
else
  gpg -d "${file}" | jq '.'
fi
